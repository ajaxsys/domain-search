
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Check domain on batch</title>
  <script type='text/javascript' src='./jquery-1.11.0.js'></script>
  <style type='text/css'>
h3 {
  font-size: 2em;
}
input[type=checkbox]
{
  /* Double-sized Checkboxes */
  -ms-transform: scale(2); /* IE */
  -moz-transform: scale(2); /* FF */
  -webkit-transform: scale(2); /* Safari and Chrome */
  -o-transform: scale(2); /* Opera */
  padding: 10px;
}
label {
  /* Checkbox text */
  font-size: 120%;
  display: inline;
}
#main {
    float : left;
    width : 94%;
    padding : 0;
    margin : 0% 3%;
    font-size: 1.6em;
}
textarea {
    font-size: 2em;
    width : 97%;
    border : solid 1px gray;
}
button {
    height: 2en;
    font-size: 1.2em;
    margin-right: 0.5em;
}
.active {
    color: green
}
.inactive {
    color: gray
}
.unknown {
    color: red
}
.hideInvalid .inactive{
    display: none;
}
.sub_title {
    background-color: gray;
    color: white;
    text-align: center;
}
.default_margin {
    margin:3%
}
  </style>

<script type='text/javascript'>//<![CDATA[

$(window).load(function(){
//checkDomain("sjkd1","jp");
var buf = [],
    timer = null,
    PARALLEL_NUM = 20;

(function () {
    enableCheckAll();

    $("#show_ok").click(function(){
        $("#result_area .results").toggleClass("hideInvalid");
    });
    $("#show_all_ok").click(function(){
        // TODO
    });

    $(".search").click(function () {
        clearResult();

        var text = $("#condition").val().replace(/\n|,|;/g, " ").replace(/^\s+|\s+$/g, '');
        if (text.length === 0) return false;

        var vals = text.split(/\s+/),
            allVals = [];
        vals = convertEscpase(vals);
        vals = convertEscpase(vals);
        // unique
        vals = $.grep(vals, function (v, k) {
            return $.inArray(v, vals) === k;
        });
        console.log(vals);

        var domains = $("#domain_area input:checkbox:checked").map(function () {
            return $(this).val();
        }).get();

        console.log(domains);

        $("#result_area").empty();
        for (var d = 0; d < domains.length; d++) {
            var $result = $("#template").clone();
            $result.attr("id", "result"+d).show();
            $("#result_area").append($result);
        }

        var eachVals = [];
        for (var d = 0; d < domains.length; d++) {
            eachVals[d] = [];
        }

        for (var d = 0; d < domains.length; d++) {

            var domain = domains[d],
                rows = "",
                randomStr = makeid(5) + "_",
                SIZE = vals.length;

            rows += "<tr class='sub_title'><td colspan=3>" + domain + "</td></tr>";
            for (var i = 1; i <= vals.length; i++) {
                rows += "<tr id='row_" + randomStr + i + "'><td>" + i + "</td><td>" + vals[i - 1] + "." + domain + "</td><td id='result_" + randomStr + i + "'>・・・</td></tr>";

                eachVals[d].push({
                    "name": vals[i - 1],
                    "domain": domain,
                    "seq": randomStr + i
                });
            }
            $("#result"+d).append(rows);
        }

        if (eachVals.length > 0) {
            for (var e = 0; e < eachVals[0].length; e++) {
                for (var d = 0; d < domains.length; d++) {
                    allVals.push(eachVals[d][e]);
                }
            }
        }


        timer = setInterval(function () {
            if (allVals.length === 0 && timer) {
                //debugger;
                clearTimer()
                console.log("Search complete.");
                return;
            }
            if (buf.length < PARALLEL_NUM && allVals.length > 0) {
                var nextSearch = allVals.shift();
                buf.push(nextSearch.seq);
                console.log(nextSearch.name, nextSearch.domain, " -- [buf]Added", nextSearch.seq);
                checkDomain(nextSearch.name, nextSearch.domain, nextSearch.seq);
            }
        }, 100);

    });
})();

function clearResult() {
    $("#result_header").nextAll().remove();

    buf = [];
    clearTimer();
}

function clearTimer() {
    if (timer) {
        clearInterval(timer);
        timer = null;
        console.log("Timmer cleared");
    }
}

function enableCheckAll() {
    $(".check_all").click(function () {
        if ($("#domain_area input:checkbox:not(:checked)").length > 0) $("#domain_area input:checkbox").prop("checked", true);
        else $("#domain_area input:checkbox").prop("checked", false);
    });
}

function makeid(n) {
    var text = "";
    var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";

    for (var i = 0; i < n; i++)
    text += possible.charAt(Math.floor(Math.random() * possible.length));

    return text;
}

function convertEscpase(vals) {
    var result = [];
    for (var v in vals) {
        var hit = false;
        if (vals[v].indexOf("\*") > -1) {
            hit = true;
            var first = "a",
                last = "z";
            for (var i = first.charCodeAt(0); i <= last.charCodeAt(0); i++) {
                result.push(vals[v].replace("\*", String.fromCharCode(i)));
            }
        }
        if (vals[v].indexOf("?") > -1) {
            hit = true;
            for (var i = 0; i <= 9; i++) {
                result.push(vals[v].replace("?", i));
            }
        }
        if (!hit) {
            result.push(vals[v]);
        }
    }
    return result;
}

function checkDomain(name, domain, seq) {

    $.ajax({
        type: 'GET',
        url: 'https://www.apisystem.com/DomainSearch/check.php',
        dataType: 'jsonp',
        data: {
            sld: name,
            tld: domain
        },
        success: function (json) {
            var status = "不明",
                style = "";
            switch (json.RrpCode) {
                case "210":
                    status = "有効";
                    style = "active";
                    break;
                case "211":
                    status = "無効";
                    style = "inactive";
                    break;
                default:
                    style = "unknown";
            }

            $("#row_" + seq).attr('class', style);
            $("#result_" + seq).text(status);
            remove(buf, seq);
        },
        error: function () {
            remove(buf, seq);
        }
    });
}

function remove(arr, what) {
    console.log("[buf]Removed", what);
    var found = arr.indexOf(what);

    while (found !== -1) {
        arr.splice(found, 1);
        found = arr.indexOf(what);
    }
}
});//]]> 

</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-70112137-1', 'auto');
  ga('send', 'pageview');

</script>
</head>
<body>
<script type="text/javascript">
    if (!mobilecheck()) $("body").css("font-size", "75%");
</script>
  <div id="main">
    
<h3>簡単、強力なドメイン名検索エンジン</h3>

    <hr>
    <p><b>【使い方】</b></p>
    <p>
        ・キーワードを空白と改行で区切り、<br />
        ・「*」は「a-z」の意味。例：ab*とは「aba, abb, ... , abz」<br />
        ・「?」は「1-9」の意味。例：ab?とは「ab0, ab1, ... , ab9」<br /></p>
    <p><b>【検索条件】</b></p>
        <div class="default_margin">
            <div id="domain_area">
                <button class="check_all">全てチェック</button>
                <input type="checkbox" checked id="i1" value="co.jp">
                <label for="i1">co.jp</label>
                <input type="checkbox" checked id="i2" value="jp">
                <label for="i2">jp</label>
                <input type="checkbox" checked id="i3" value="com">
                <label for="i3">com</label>
                <input type="checkbox" id="i4" value="net">
                <label for="i4">net</label>
                <input type="checkbox" id="i5" value="org">
                <label for="i5">org</label>
                <button class="search">検索</button> 
            </div>
            <br /><br />
            <textarea id="condition" rows="4">*dh</textarea>
            <br /><br />
            <button class="search">検索</button>
            <input type="checkbox" id="show_ok">
            <label for="show_ok">有効な検索結果のみ表示</label>
            <input type="checkbox" id="show_all_ok">
            <label for="show_ok">全てDomain一致のみ表示</label>
        </div>

        <table id="template" class="results" class="hideInvalid" border="1" width="280px" style="float: left;display:none">
            <thead id="result_header">
                <tr>
                    <th>#</th>
                    <th>Domain</th>
                    <th>Result</th>
                </tr>
            </thead>
        </table>
        <div id="result_area" class="default_margin" width="900px">
        </div>
</div>

</body>

</html>

